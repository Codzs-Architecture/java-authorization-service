spring:
  application:
    name: java-authorization-service

  security:
    # user:
    #   name: authorization-service-user
    #   password: ${authorization.password}
    #   roles: MANAGEMENT_ADMIN
    oauth2:
      client:
        registration:
          google-idp:
            provider: google
            client-id: ${google.client_id}
            client-secret: ${google.client_secret}
            scope: openid, https://www.googleapis.com/auth/userinfo.profile, https://www.googleapis.com/auth/userinfo.email
            client-name: Sign in with Google
          github-idp:
            provider: github
            client-id: ${github.client_id}
            client-secret: ${github.client_secret}
            scope: user:email, read:user
            client-name: Sign in with GitHub
        provider:
          google:
            user-name-attribute: email
          github:
            user-name-attribute: login

  profiles:
    include: keystore,config-service

  # Flyway configuration to handle existing schemas  
  flyway:
    baseline-on-migrate: true
    baseline-version: 0
    enabled: true
    locations: classpath:db/migration
    validate-on-migrate: false
    clean-disabled: false
    # Handle existing databases by checking if tables exist
    baseline-description: "Baseline existing database"
    # Only apply new migrations
    out-of-order: true

  # Spring WebMVC configuration to handle exception conflicts
  # mvc:
  #   problemdetails:
  #     enabled: false

  # Exclude conflicting auto-configurations  
  # autoconfigure:
  #   exclude:
  #     - org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration

  # # Disable problematic beans
  # main:
  #   allow-bean-definition-overriding: true

# Entry to show this information on spring boot admin
#info:
#  app:
#    encoding: @project.build.sourceEncoding@
#    java:
#      source: @java.version@
#      target: @java.version@

# Management-specific configuration
management:
  server:
    port: 6003

server:
  port: 5003

# Logging configuration
logging:
  level:
    root: INFO
    org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver: ERROR
    org.springframework.web.method.HandlerMethodMappingNamingStrategy: ERROR
    org.springframework.web: DEBUG
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG
    org.springframework.security.web: DEBUG
    org.springframework.security.authentication: DEBUG
    org.springframework.security.authorization: DEBUG
    org.springframework.security.web.authentication: DEBUG
    org.springframework.security.web.access: DEBUG
    org.springframework.security.oauth2.server.authorization: DEBUG
    org.springframework.security.oauth2.server.authorization.web: DEBUG
    org.springframework.security.oauth2.server.authorization.authentication: DEBUG
    org.springframework.security.oauth2.server.authorization.client: DEBUG
    org.springframework.security.oauth2.server.authorization.oidc: DEBUG
    org.springframework.security.oauth2.core: DEBUG
    org.springframework.security.oauth2.jose: DEBUG
    org.springframework.security.oauth2.jwt: DEBUG
    org.springframework.jdbc: DEBUG
    org.springframework.web.client: DEBUG
    org.springframework.http: DEBUG
    com.codzs: DEBUG

acl:
  redis:
    cache:
      key: com.codzs.acl.cache.local

# Device Authorization Security Configuration
device:
  security:
    rate-limiting:
      enabled: true
      requests-per-minute: 10
      time-window-minutes: 1
      # Note: Rate limiting protects against device code enumeration attacks
      # and prevents abuse of device authorization endpoints

# Resilience4j Configuration for Rate Limiting
resilience4j:
  ratelimiter:
    instances:
      device-authorization:
        limit-for-period: 10
        limit-refresh-period: 60s
        timeout-duration: 100ms
        register-health-indicator: true
        event-consumer-buffer-size: 100
    metrics:
      enabled: true
      distribution-statistic-expiry: 1m
      distribution-statistic-buffer-size: 100
